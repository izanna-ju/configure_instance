version: 2.1

jobs:
  # upload_file:
  #   docker:
  #     - image: circleci/node:13.8.0
  #   steps:
  #     - run: echo "THIS IS A SAMPLE TEXT" > ~/output.txt  
  #     - persist_to_workspace:
  #         root: ~/
  #         paths: 
  #           - output.txt  

  # download_file:
  #   docker:
  #     - image: circleci/node:13.8.0
  #   steps:
  #     - attach_workspace:
  #         at: ~/
  #     - run: cat ~/output.txt 
 
  # Exercise: Infrastructure Creation
  # Exercise - Rollback

  # create-infrastructure:
  #   docker:
  #     - image: amazon/aws-cli
  #   steps:
  #     - checkout
  #     - run:
  #         name: "Create Cloudformation Stack Command"
  #         command: |
  #           aws cloudformation deploy \
  #           --template-file template.yml \
  #           --stack-name juliusStack-${CIRCLE_WORKFLOW_ID:0:5} \
  #           --region us-east-1 
  
  configure-infrastructure:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints: ["cc:3f:bd:62:22:5b:05:02:02:73:58:c4:84:44:f7:a4"]
      - run:
          name: Update packages
          command: | 
            apt update
      
      - run:
          name: Install pip
          command: |
            apt install python3-pip
      
      - run:
          name: Install Ansible
          command: |
            pip3 install ansible
      - run:
          name: Run Playbook and Configure server
          command: | 
            ansible-playbook -i inventory.txt main-remote.yml

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  infrastructure-workflow:
    jobs:
      # - upload_file
      # - download_file:
      #     requires: [upload_file]
      # - create-infrastructure
      - configure-infrastructure